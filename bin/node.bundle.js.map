{"version":3,"sources":["webpack:///webpack/bootstrap 5ed23ceb9c6b8be6b9e2","webpack:///external \"bluebird\"","webpack:///external \"lodash\"","webpack:///./src/actions.js","webpack:///external \"@rocket.chat/sdk\"","webpack:///./src/index.js","webpack:///./src/outgoing.js","webpack:///./src/rocketchat.js","webpack:///./src/umm.js","webpack:///external \"util\""],"names":["require","driver","create","resolve","reject","promise","Promise","r","rj","messageId","Date","toISOString","Math","random","newEvent","Object","assign","_promise","_resolve","_reject","__id","obj","validateText","text","Error","validateAttachments","attachments","createText","channelId","options","platform","type","raw","createAttachments","createReaction","name","livechatTransfer","callMethod","method","args","module","exports","rocketchat","outgoingMiddleware","event","next","outgoing","config","ROCKETCHAT_USER","default","env","ROCKETCHAT_PASSWORD","ROCKETCHAT_URL","ROCKETCHAT_USE_SSL","ROCKETCHAT_ROOM","scope","init","bp","middlewares","register","order","handler","description","_","forIn","actions","action","sendName","replace","msg","apply","arguments","sendOutgoing","ready","configurator","loadAll","RocketChat","connect","listen","handlePromise","then","res","catch","console","log","err","handleText","sendMessage","handleAttachments","connected","handleChannel","channelList","undefined","toLowerCase","match","split","useSSL","host","useSsl","login","username","password","joinRooms","subscribeToMessages","message","userId","u","_id","id","db","get","knex","where","users","existingUser","newUser","first_name","last_name","gender","timezone","picture_url","locale","created_on","number","saveUser","getOrCreateUser","dm","livechat","edited","respondToMessages","meta","t","user","sendIncoming","channel","rid","ts","$date","direct","roomType","messageType","sendToRoomId","sendDirectToUser","fromCallback","disconnect","getChannelId","getMessageTs","processOutgoing","blocName","instruction","ins","optionsList","prop","isNil","attachment","reaction","timestamp","strRep","util","inspect","at","umm","registerConnector","templates"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/home/kb0304/ws/viasat/botpress/botpress-channel-rocketchat\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 5ed23ceb9c6b8be6b9e2","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 1\n// module chunks = 0","import Promise from \"bluebird\";\nconst { driver } = require(\"@rocket.chat/sdk\");\n\nconst create = obj => {\n  let resolve = null;\n  let reject = null;\n  const promise = new Promise((r, rj) => {\n    resolve = r;\n    reject = rj;\n  });\n\n  const messageId = new Date().toISOString() + Math.random();\n\n  const newEvent = Object.assign(\n    {\n      _promise: promise,\n      _resolve: resolve,\n      _reject: reject,\n      __id: messageId\n    },\n    obj\n  );\n\n  return newEvent;\n};\n\nconst validateText = text => {\n  if (typeof text !== \"string\") {\n    throw new Error(\"Text must be a string.\");\n  }\n};\n\nconst validateAttachments = attachments => {\n  if (typeof attachments !== \"object\") {\n    throw new Error(\"Expected attachments type to be an object\");\n  }\n};\n\nconst createText = (channelId, text, options = {}) => {\n  validateText(text);\n  return create({\n    platform: \"rocketchat\",\n    type: \"text\",\n    text: text,\n    raw: {\n      channelId: channelId,\n      options: options\n    }\n  });\n};\n\nconst createAttachments = (channelId, attachments, options = {}) => {\n  validateAttachments(attachments);\n\n  return create({\n    platform: \"rocketchat\",\n    type: \"attachments\",\n    text: \"App sent an attachments\",\n    raw: {\n      channelId: channelId,\n      attachments: attachments,\n      options: options\n    }\n  });\n};\n\nconst createReaction = (name, options = {}) => {\n  return create({\n    platform: \"rocketchat\",\n    type: \"reaction\",\n    text: \"App sent a reaction\",\n    raw: {\n      name: name,\n      options: options\n    }\n  });\n};\n\n// TODO\nconst livechatTransfer = (name, options = {}) => {\n  return create({\n    platform: \"rocketchat\",\n    type: \"livechat_transfer\",\n    text: \"transfer livechat\",\n    raw: {\n      name: name,\n      options: options\n    }\n  });\n};\n\nconst callMethod = (method, ...args) => {\n  return driver.callMethod(method, args);\n};\n\nmodule.exports = {\n  createText,\n  createAttachments,\n  createReaction,\n  livechatTransfer,\n  callMethod\n};\n\n\n\n// WEBPACK FOOTER //\n// ./src/actions.js","module.exports = require(\"@rocket.chat/sdk\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"@rocket.chat/sdk\"\n// module id = 3\n// module chunks = 0","import _ from \"lodash\";\nimport Promise from \"bluebird\";\nimport actions from \"./actions\";\nimport outgoing from \"./outgoing\";\nimport RocketChat from \"./rocketchat\";\nimport UMM from \"./umm\";\n\nlet rocketchat = null;\n\nconst outgoingMiddleware = async (event, next) => {\n  if (event.platform !== \"rocketchat\") {\n    return next();\n  }\n\n  if (!outgoing[event.type]) {\n    return next(\"Unsupported event type: \" + event.type);\n  }\n  await outgoing[event.type](event, next, rocketchat);\n};\n\nmodule.exports = {\n  config: {\n    ROCKETCHAT_USER: {\n      type: \"string\",\n      default: \"\",\n      env: \"ROCKETCHAT_USERNAME\"\n    },\n    ROCKETCHAT_PASSWORD: {\n      type: \"string\",\n      default: \"\",\n      env: \"ROCKETCHAT_PASSWORD\"\n    },\n    ROCKETCHAT_URL: { type: \"string\", default: \"\", env: \"ROCKETCHAT_HOST\" },\n    ROCKETCHAT_USE_SSL: {\n      type: \"string\",\n      default: \"\",\n      env: \"ROCKETCHAT_USESSL\"\n    },\n    ROCKETCHAT_ROOM: {\n      type: \"string\",\n      default: \"\",\n      env: \"ROCKETCHAT_SUBSCRIBETO\"\n    },\n    scope: {\n      type: \"string\",\n      default:\n        \"admin,bot,chat:write:bot,commands,identify,incoming-webhook,channels:read\",\n      env: \"ROCKETCHAT_SCOPE\"\n    }\n  },\n\n  init(bp) {\n    bp.middlewares.register({\n      name: \"rocketchat.sendMessages\",\n      type: \"outgoing\",\n      order: 100,\n      handler: outgoingMiddleware,\n      module: \"botpress-channel-rocketchat\",\n      description: \"Sends messages to Rocket.Chat\"\n    });\n\n    bp.rocketchat = {};\n    _.forIn(actions, (action, name) => {\n      bp.rocketchat[name] = actions[name];\n      const sendName = name.replace(/^create/, \"send\");\n      bp.rocketchat[sendName] = Promise.method(function() {\n        const msg = action.apply(this, arguments);\n        return bp.middlewares.sendOutgoing(msg);\n      });\n    });\n    UMM(bp);\n  },\n\n  ready: async function(bp, configurator) {\n    const config = await configurator.loadAll();\n\n    rocketchat = new RocketChat(bp, config);\n    await rocketchat.connect(bp);\n    return rocketchat.listen(bp);\n  }\n};\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","const handlePromise = (event, next, promise) => {\n  return promise\n    .then(res => {\n      //console.log('WE ARE GOING NEXT PROMISE')\n      next();\n      event._resolve && event._resolve();\n      return res;\n    })\n    .catch(err => {\n      console.log(\"THERE WAS AN ERROR\");\n      next(err);\n      event._reject && event._reject(err);\n      throw err;\n    });\n};\n\nconst handleText = (event, next, rocketchat) => {\n  if (event.platform !== \"rocketchat\" || event.type !== \"text\") {\n    return next();\n  }\n  //console.log(\"HANDLE TEXT\")\n  const text = event.text;\n  const options = {};\n\n  return handlePromise(event, next, rocketchat.sendMessage(text, options, event));\n};\n\nconst handleAttachments = (event, next, rocketchat) => {\n  if (event.platform !== \"rocketchat\" || event.type !== \"attachments\") {\n    return next();\n  }\n\n  //console.log(\"HANDLE TEXT\")\n  const msg = {\n    attachments: event.raw.attachments || []\n  }\n  const options = {};\n\n  return handlePromise(event, next, rocketchat.sendMessage(msg, options, event));\n};\n\nmodule.exports = {\n  text: handleText,\n  attachments: handleAttachments\n};\n\n\n\n// WEBPACK FOOTER //\n// ./src/outgoing.js","const { driver } = require(\"@rocket.chat/sdk\");\nimport Promise from \"bluebird\";\n\nclass RocketChat {\n  constructor(bp, config) {\n    if (!bp || !config) {\n      throw new Error(\"You need to specify botpress and config\");\n    }\n\n    this.config = config;\n    this.connected = false;\n  }\n\n  async connect() {\n    function handleChannel(channelList) {\n      if (channelList !== undefined) {\n        channelList = channelList.replace(/[^\\w\\,._]/gi, \"\").toLowerCase();\n        if (channelList.match(\",\")) {\n          channelList = channelList.split(\",\");\n        } else if (channelList !== \"\") {\n          channelList = [channelList];\n        } else {\n          channelList = [];\n        }\n      }\n\n      return channelList;\n    }\n\n    try {\n      const useSSL = this.config.ROCKETCHAT_USE_SSL === \"true\";\n      await driver.connect({\n        host: this.config.ROCKETCHAT_URL,\n        useSsl: useSSL\n      });\n      await driver.login({\n        username: this.config.ROCKETCHAT_USER,\n        password: this.config.ROCKETCHAT_PASSWORD\n      });\n      await driver.joinRooms(handleChannel(this.config.ROCKETCHAT_ROOM));\n      await driver.subscribeToMessages();\n      this.connected = true;\n    } catch (error) {\n      console.log(error);\n    }\n  }\n\n  async listen(bp) {\n    // Insert new user to db\n    async function getOrCreateUser(message) {\n      //console.log('GETORCREATEUSER')\n      const userId = message.u._id;\n      const id = `rocketchat:${userId}`;\n      const existingUser = await bp.db\n        .get()\n        .then(knex => knex(\"users\").where(\"id\", id))\n        .then(users => users[0]);\n      if (existingUser) {\n        existingUser.id = userId;\n        return existingUser;\n      } else {\n        const newUser = {\n          id: id,\n          userId: userId,\n          username: message.u.username,\n          platform: \"rocketchat\",\n          first_name: message.u.name,\n          last_name: \"\",\n          gender: \"\",\n          timezone: null,\n          picture_url: null,\n          locale: null,\n          created_on: \"\",\n          number: userId\n        };\n        await bp.db.saveUser(newUser);\n        return newUser;\n      }\n    }\n    console.log(\"LISTEN TRIGGERED\");\n    const options = {\n      dm: true,\n      livechat: true,\n      edited: true\n    };\n    return driver.respondToMessages(async function(err, message, meta) {\n      // If message have .t so it's a system message, so ignore it\n      if (message.t === undefined) {\n        const user = await getOrCreateUser(message);\n        await bp.middlewares.sendIncoming({\n          platform: \"rocketchat\",\n          type: \"message\",\n          text: message.msg,\n          user: user,\n          channel: message.rid,\n          ts: message.ts.$date,\n          direct: false,\n          roomType: meta.roomType,\n          raw: message\n        });\n      }\n    }, options);\n  }\n\n  setConfig(config) {\n    this.config = config;\n  }\n\n  sendMessage(msg, options, event) {\n    const messageType = event.raw.options.roomType;\n    const channelId = event.raw.channelId;\n    const username = event.raw.options.user.username;\n    if (messageType !== undefined) {\n      if (messageType == \"c\") {\n        return driver.sendToRoomId(msg, channelId);\n      } else if (messageType == \"p\") {\n        return driver.sendToRoomId(msg, channelId);\n      } else if (messageType == \"d\") {\n        return driver.sendDirectToUser(msg, username);\n      } else if (messageType == \"l\") {\n        return driver.sendToRoomId(msg, channelId);\n      } else {\n        console.log(\"ERROR WHILE SENDING MESSAGE\");\n      }\n    } else {\n      console.log(\"MESSAGE TYPE UNDEFINED\");\n    }\n  }\n\n  sendUpdateText(ts, channelId, text) {\n    return Promise.fromCallback(() => {\n      driver.sendToRoomId(text, channelId, {});\n    });\n  }\n\n  isConnected() {\n    return this.connected;\n  }\n\n  async disconnect() {\n    await driver.disconnect();\n  }\n}\n\nmodule.exports = RocketChat;\n\n\n\n// WEBPACK FOOTER //\n// ./src/rocketchat.js","import util from \"util\";\nimport _ from \"lodash\";\n\nimport actions from \"./actions\";\n\nfunction getChannelId(event) {\n  const channelId = event.channel;\n  if (!channelId) {\n    throw new Error(\"Could not find channelId in the incoming event.\");\n  }\n\n  return channelId;\n}\n\nfunction getMessageTs(event) {\n  const ts = _.get(event, \"ts\") || _.get(event, \"raw.ts\");\n\n  if (!ts) {\n    throw new Error(\n      \"Could not find message timestamp (ts) in the incoming event.\"\n    );\n  }\n\n  return ts;\n}\n\nfunction processOutgoing({ event, blocName, instruction }) {\n  const ins = Object.assign({}, instruction); // Create a shallow copy of the instruction\n\n  ////////\n  // PRE-PROCESSING\n  ////////\n\n  const optionsList = [];\n\n  for (const prop of optionsList) {\n    delete ins[prop];\n  }\n\n  /////////\n  /// Processing\n  /////////\n\n  if (!_.isNil(instruction.attachments)) {\n    return actions.createAttachments(\n      getChannelId(event),\n      instruction.attachments,\n      instruction.options\n    );\n  }\n\n  if (!_.isNil(instruction.attachment)) {\n    return actions.createAttachments(\n      getChannelId(event),\n      [instruction.attachment],\n      instruction.options\n    );\n  }\n\n  if (!_.isNil(instruction.text)) {\n    return actions.createText(getChannelId(event), instruction.text, event);\n  }\n\n  if (!_.isNil(instruction.reaction)) {\n    return actions.createReaction(\n      instruction.reaction,\n      Object.assign(\n        {},\n        {\n          timestamp: getMessageTs(event),\n          channel: getChannelId(event)\n        },\n        instruction.options\n      )\n    );\n  }\n\n  ////////////\n  /// POST-PROCESSING\n  ////////////\n\n  // Nothing to post-process yet\n\n  ////////////\n  /// INVALID INSTRUCTION\n  ////////////\n\n  const strRep = util.inspect(instruction, false, 1);\n  throw new Error(\n    `Unrecognized instruction on RocketChat in bloc '${blocName}': ${strRep}`\n  );\n}\n\nmodule.exports = bp => {\n  const [umm, registerConnector] = _.at(bp, [\"umm\", \"umm.registerConnector\"]);\n\n  umm &&\n    registerConnector &&\n    registerConnector({\n      platform: \"rocketchat\",\n      processOutgoing: args => processOutgoing(Object.assign({}, args, { bp })),\n      templates: []\n    });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./src/umm.js","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 9\n// module chunks = 0"],"sourceRoot":""}